<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlyFlex</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    input { margin-bottom: 6px; }
  </style>
</head>
<body>
  <h1>Ricerca Volo</h1>

  <h2>Ricerca standard</h2>
  <form action="/search-flights" method="POST">
    <label>Da (aeroporto): <input name="from" required class="awesomplete airport-input" /></label><br />
    <label>A (aeroporto): <input name="to" required class="awesomplete airport-input" /></label><br />
    <label>Date (max 2): <input name="dates" id="dates-standard" required /></label><br />
    <label>Ora Min (es. 06:00): <input type="time" name="time_min" required /></label><br />
    <label>Ora Max (es. 10:00): <input type="time" name="time_max" required /></label><br />
    <button type="submit">Cerca Voli</button>
  </form>

  <hr />

  <h2>Ricerca Avanzata da Pi√π Aeroporti con Fascia Oraria</h2>
  <form action="/multi-origin-advanced" method="POST" onsubmit="return validateLimits()">
    <label>Aeroporti (max 3, separati da virgola): <input id="airports" name="airports" required class="awesomplete airport-input" /></label><br />
    <label>Date (max 2): <input id="dates" name="dates" required /></label><br />
    <label>Ora Min (es. 06:00): <input type="time" name="time_min" required /></label><br />
    <label>Ora Max (es. 10:00): <input type="time" name="time_max" required /></label><br />
    <button type="submit">Cerca Voli</button>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    function extractAirportCode(value) {
      return value.split(' - ')[0].trim();
    }

    fetch('/airports.json')
      .then(res => res.json())
      .then(data => {
        const airportList = data.map(a => `${a.code} - ${a.name}`);

        document.querySelectorAll(".airport-input").forEach(input => {
          new Awesomplete(input, {
            list: airportList,
            minChars: 1,
            autoFirst: true,
            filter: Awesomplete.FILTER_CONTAINS
          });
        });

        document.querySelectorAll("form").forEach(form => {
          form.addEventListener("submit", () => {
            if (form.querySelector('[name="from"]')) {
              form.querySelector('[name="from"]').value = extractAirportCode(form.querySelector('[name="from"]').value);
            }
            if (form.querySelector('[name="to"]')) {
              form.querySelector('[name="to"]').value = extractAirportCode(form.querySelector('[name="to"]').value);
            }
            if (form.querySelector('[name="airports"]')) {
              const values = form.querySelector('[name="airports"]').value
                .split(',')
                .map(v => extractAirportCode(v))
                .join(',');
              form.querySelector('[name="airports"]').value = values;
            }
          });
        });
      });

    flatpickr("#dates", {
      mode: "multiple",
      maxDate: "2099-12-31",
      dateFormat: "Y-m-d",
      maxItems: 2
    });

    flatpickr("#dates-standard", {
      mode: "multiple",
      maxDate: "2099-12-31",
      dateFormat: "Y-m-d",
      maxItems: 2
    });

    function validateLimits() {
      const airportCount = document.getElementById("airports").value.split(',').filter(a => a.trim()).length;
      const dateCount = document.getElementById("dates").value.split(',').filter(d => d.trim()).length;

      if (airportCount > 3) {
        alert("Puoi selezionare al massimo 3 aeroporti.");
        return false;
      }

      if (dateCount > 2) {
        alert("Puoi selezionare al massimo 2 date.");
        return false;
      }

      return true;
    }
  </script>
</body>
</html>
